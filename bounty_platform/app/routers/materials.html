{% extends "base.html" %}
{% block title %}ç´ æåº“ç®¡ç†{% endblock %}

{% block head %}
<style>
    .xhs-modal .modal-dialog { max-width: 900px; width: 90%; }
    .xhs-modal .modal-content { border-radius: 16px; overflow: hidden; border: none; }
    .xhs-modal .modal-body { padding: 0; height: 70vh; display: flex; }
    .xhs-img-container { background-color: #000; display: flex; align-items: center; justify-content: center; height: 100%; overflow: hidden; position: relative; }
    .xhs-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .xhs-edit-container { padding: 24px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; }
    .material-card { cursor: pointer; transition: transform 0.2s; position: relative; }
    .material-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .check-overlay { position: absolute; top: 5px; left: 5px; z-index: 10; }
    .form-check-input { width: 1.5em; height: 1.5em; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">ğŸ’ ç´ æå¼¹è¯åº“</h4>
    <div class="d-flex gap-2">
        <input type="text" id="searchKeyword" class="form-control" placeholder="æœç´¢ç´ ææ ‡é¢˜..." onkeyup="if(event.keyCode==13) loadMaterials()">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCatModal">
            <i class="fas fa-folder-plus"></i> æ–°å»ºåˆ†ç±»
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-2">
        <div class="list-group shadow-sm">
            <a href="#" class="list-group-item list-group-item-action fw-bold" onclick="selectCat(0, 'å…¨éƒ¨ç´ æ')">ğŸ“‚ å…¨éƒ¨ç´ æ</a>
            {% for cat in categories %}
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="selectCat({{ cat.id }}, '{{ cat.name }}')">
                <span>{{ cat.name }}</span>
                <span class="badge bg-secondary rounded-pill">{{ cat.total_count }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-10">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <h5 class="m-0">ğŸ“‚ <span id="currentCatName" class="text-primary">å…¨éƒ¨ç´ æ</span></h5>
                    <div id="batchBar" style="display:none;" class="vr-left ps-3 border-start">
                        <button class="btn btn-danger btn-sm me-1" onclick="batchAction('delete')"><i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤</button>
                        <button class="btn btn-info btn-sm text-white" onclick="$('#moveModal').modal('show')"><i class="fas fa-exchange-alt"></i> æ‰¹é‡ç§»åŠ¨</button>
                    </div>
                </div>
                <button class="btn btn-success btn-sm" onclick="$('#uploadArea').slideToggle()">
                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ ç´ æ
                </button>
            </div>
            
            <div class="card-body">
                <div id="uploadArea" style="display:none;" class="mb-4 p-3 bg-light rounded">
                    <form id="uploadForm">
                        <input type="hidden" name="cat_id" id="uploadCatId">
                        <div class="mb-3"><input type="file" name="files" class="form-control" multiple accept="image/*"></div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="is_carousel" id="carouselSwitch">
                            <label class="form-check-label fw-bold" for="carouselSwitch">â­•ï¸ åˆå¹¶ä¸ºå¤šå›¾è½®æ’­è´´</label>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-12"><input type="text" name="title" class="form-control" placeholder="æ ‡é¢˜"></div>
                            <div class="col-12"><textarea name="content" class="form-control" rows="3" placeholder="æ–‡æ¡ˆ..."></textarea></div>
                        </div>
                        <button type="button" onclick="doUpload()" class="btn btn-primary w-100">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
                    </form>
                </div>

                <div id="matList" class="row g-3">
                    </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">æ‰¹é‡ç§»åŠ¨åˆ°...</h5></div>
            <div class="modal-body">
                <select id="targetCatSelect" class="form-select">
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat.name }}</option>{% endfor %}
                </select>
            </div>
            <div class="modal-footer"><button onclick="batchAction('move')" class="btn btn-primary w-100">ç¡®è®¤ç§»åŠ¨</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="newCatModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body"><input type="text" id="newCatName" class="form-control" placeholder="è¾“å…¥åˆ†ç±»åç§°"></div>
            <div class="modal-footer"><button type="button" onclick="createCategory()" class="btn btn-primary w-100">åˆ›å»º</button></div>
        </div>
    </div>
</div>

<div class="modal fade xhs-modal" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body row g-0">
                <div class="col-md-7 xhs-img-container"><img id="modalImg" src=""></div>
                <div class="col-md-5 xhs-edit-container">
                    <h5 id="modalTitle" class="fw-bold mb-3"></h5>
                    <div id="modalContent" class="text-muted flex-grow-1" style="white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentCatId = 0;

    function selectCat(id, name) {
        currentCatId = id;
        $('#currentCatName').text(name);
        $('#uploadCatId').val(id);
        loadMaterials();
    }

    function loadMaterials() {
        let kw = $('#searchKeyword').val();
        let url = '/admin/materials/list/' + currentCatId + (kw ? '?keyword=' + kw : '');
        
        $('#matList').html('<div class="spinner-border text-primary m-auto"></div>');
        
        $.get(url, function(res) {
            $('#matList').empty();
            if(res.length === 0) $('#matList').html('<p class="text-center text-muted col-12">æš‚æ— ç´ æ</p>');
            
            res.forEach(item => {
                let imgs = item.images; // å·²ç»æ˜¯æ•°ç»„
                let cover = imgs[0];
                let badge = imgs.length > 1 ? `<span class="position-absolute bottom-0 end-0 badge bg-dark m-1">${imgs.length}å›¾</span>` : '';
                
                let html = `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm material-card">
                        <div class="check-overlay" onclick="event.stopPropagation()">
                            <input type="checkbox" class="form-check-input mat-check" value="${item.id}" onchange="toggleBatchBar()">
                        </div>
                        <div class="position-relative" onclick='openModal(${JSON.stringify(item)})'>
                            <img src="${cover}" class="card-img-top" style="height:150px; object-fit:cover;">
                            ${badge}
                        </div>
                        <div class="card-body p-2" onclick='openModal(${JSON.stringify(item)})'>
                            <h6 class="text-truncate small mb-1 fw-bold">${item.title}</h6>
                        </div>
                    </div>
                </div>`;
                $('#matList').append(html);
            });
        });
    }

    function toggleBatchBar() {
        let count = $('.mat-check:checked').length;
        if(count > 0) $('#batchBar').show();
        else $('#batchBar').hide();
    }

    function batchAction(action) {
        let ids = [];
        $('.mat-check:checked').each(function() { ids.push(parseInt($(this).val())); });
        
        let data = { action: action, material_ids: JSON.stringify(ids) };
        if(action === 'move') data.target_cat_id = $('#targetCatSelect').val();
        
        if(confirm(`ç¡®å®šè¦æ‰¹é‡${action === 'delete' ? 'åˆ é™¤' : 'ç§»åŠ¨'}è¿™ ${ids.length} ä¸ªç´ æå—ï¼Ÿ`)) {
            apiPost('/admin/materials/batch', data, function() {
                loadMaterials();
                $('#moveModal').modal('hide');
                $('#batchBar').hide();
            });
        }
    }

    // ä¸Šä¼ å’Œåˆ›å»ºåˆ†ç±»çš„å‡½æ•°ä¿æŒä¹‹å‰çš„é€»è¾‘
    function doUpload() {
        if(!$('#uploadCatId').val() || $('#uploadCatId').val() == 0) return Swal.fire('æç¤º', 'è¯·å…ˆé€‰æ‹©å…·ä½“åˆ†ç±»(ä¸èƒ½é€‰å…¨éƒ¨)', 'warning');
        let formData = new FormData($('#uploadForm')[0]);
        $.ajax({
            url: '/admin/materials/upload', type: 'POST', data: formData, processData: false, contentType: false,
            success: function(res) {
                if(res.code===200){ Swal.fire('æˆåŠŸ','ä¸Šä¼ å®Œæˆ','success'); $('#uploadArea').slideUp(); loadMaterials(); }
                else Swal.fire('å¤±è´¥', res.message, 'error');
            }
        });
    }

    function createCategory() {
        let name = $('#newCatName').val();
        if(!name) return;
        apiPost('/admin/materials/category/add', {name:name}, function(){ location.reload(); });
    }
    
    // è¯¦æƒ…å±•ç¤ºé€»è¾‘
    function openModal(item) {
        $('#modalImg').attr('src', item.images[0]);
        $('#modalTitle').text(item.title);
        $('#modalContent').text(item.content);
        new bootstrap.Modal('#detailModal').show();
    }
    
    // åˆå§‹åŒ–åŠ è½½
    loadMaterials();
</script>
{% endblock %}
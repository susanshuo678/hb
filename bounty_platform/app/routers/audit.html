{% extends "base.html" %}
{% block title %}ä»»åŠ¡å®¡æ ¸{% endblock %}

{% block head %}
<style>
    .compare-container { display: flex; gap: 10px; align-items: center; }
    .compare-box { width: 100px; height: 100px; border: 1px dashed #ccc; border-radius: 4px; overflow: hidden; position: relative; cursor: zoom-in; }
    .compare-box img { width: 100%; height: 100%; object-fit: cover; }
    .compare-label { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 10px; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-check-square text-primary me-2"></i>å®¡æ ¸ä¸­å¿ƒ</h4>
        <div class="btn-group">
            <a href="/admin/audit?status=pending" class="btn btn-{{ 'primary' if status=='pending' else 'outline-primary' }}">å¾…å®¡æ ¸</a>
            <a href="/admin/audit?status=appealing" class="btn btn-{{ 'primary' if status=='appealing' else 'outline-primary' }}">
                ç”³è¯‰ä¸­ <span class="badge bg-danger">!</span>
            </a>
        </div>
    </div>
    
    <div class="card shadow-sm border-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>ç”¨æˆ·</th>
                    <th>ä»»åŠ¡ä¿¡æ¯</th>
                    <th>ğŸ” åŒå±å¯¹æ¯” (å·¦æ ‡å‡† vs å³æäº¤)</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in submissions %}
                <tr>
                    <td>
                        <div class="fw-bold">{{ sub.user.username }}</div>
                        <div class="small text-muted">ID: {{ sub.user_id }}</div>
                    </td>
                    <td>
                        <div class="fw-bold">{{ sub.task.title }}</div>
                        <div class="text-danger small">Â¥ {{ sub.task.price }} ({{ sub.task.price_mode }})</div>
                        {% if sub.status == 'appealing' %}
                        <div class="mt-1 bg-warning-subtle text-dark p-1 rounded small">
                            <strong>ç”³è¯‰ç†ç”±:</strong> {{ sub.appeal_reason }}
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="compare-container">
                            <div class="compare-box border-primary" onclick="window.open('{{ sub.ref_images[0] if sub.ref_images else '' }}')">
                                {% if sub.ref_images %}
                                <img src="{{ sub.ref_images[0] }}">
                                <div class="compare-label bg-primary">æ ‡å‡†å‚è€ƒ</div>
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center h-100 bg-light text-muted small">æ— ç´ æ</div>
                                {% endif %}
                            </div>

                            <i class="fas fa-arrow-right text-muted"></i>

                            <div class="compare-box border-success" onclick="window.open('/static/{{ sub.screenshot_path }}')">
                                <img src="/static/{{ sub.screenshot_path }}">
                                <div class="compare-label bg-success">ç”¨æˆ·æäº¤</div>
                            </div>

                            {% if sub.appeal_img %}
                            <i class="fas fa-plus text-muted"></i>
                            <div class="compare-box border-warning" onclick="window.open('/static/{{ sub.appeal_img }}')">
                                <img src="/static/{{ sub.appeal_img }}">
                                <div class="compare-label bg-warning text-dark">ç”³è¯‰è¯æ®</div>
                            </div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if sub.status == 'appealing' %}
                        <span class="badge bg-warning text-dark">âš–ï¸ ç”³è¯‰å¤å®¡</span>
                        {% else %}
                        <span class="badge bg-info text-dark">â³ å¾…åˆå®¡</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success" 
                            onclick="openApprove('{{ sub.id }}', '{{ sub.task.price_mode }}', '{{ sub.task.price }}')">
                            é€šè¿‡
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                            onclick="openReject('{{ sub.id }}')">
                            é©³å›
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="5" class="text-center py-5 text-muted">æš‚æ— å¾…åŠä»»åŠ¡</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if total_pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if page <= 1 %}disabled{% endif %}"><a class="page-link" href="?status={{ status }}&page={{ page - 1 }}">ä¸Šä¸€é¡µ</a></li>
            <li class="page-item disabled"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}"><a class="page-link" href="?status={{ status }}&page={{ page + 1 }}">ä¸‹ä¸€é¡µ</a></li>
        </ul>
    </nav>
    {% endif %}
</div>

<div class="modal fade" id="rejectModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/admin/audit/review" method="post" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">é©³å›åŸå› </h5></div>
            <div class="modal-body">
                <input type="hidden" name="submission_id" id="rejectSubId">
                <input type="hidden" name="action" value="reject">
                <textarea name="feedback" class="form-control" rows="3" required></textarea>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-danger">ç¡®è®¤é©³å›</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="approveModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/admin/audit/review" method="post" class="modal-content">
            <div class="modal-header"><h5 class="modal-title">é€šè¿‡å®¡æ ¸</h5></div>
            <div class="modal-body">
                <input type="hidden" name="submission_id" id="approveSubId">
                <input type="hidden" name="action" value="approve">
                <div id="dynamicInput" style="display:none;">
                    <label class="form-label text-primary fw-bold">è¾“å…¥ç»“ç®—é‡‘é¢</label>
                    <input type="number" step="0.01" name="amount" class="form-control">
                </div>
                <div id="fixedMsg" class="alert alert-success" style="display:none;">å›ºå®šé‡‘é¢ï¼š<span id="fixedVal"></span> å…ƒ</div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">ç¡®è®¤ç»“ç®—</button></div>
        </form>
    </div>
</div>

<script>
function openApprove(id, mode, price) {
    document.getElementById('approveSubId').value = id;
    if(mode === 'dynamic') {
        document.getElementById('dynamicInput').style.display = 'block';
        document.getElementById('fixedMsg').style.display = 'none';
    } else {
        document.getElementById('dynamicInput').style.display = 'none';
        document.getElementById('fixedMsg').style.display = 'block';
        document.getElementById('fixedVal').innerText = price;
    }
    new bootstrap.Modal(document.getElementById('approveModal')).show();
}
function openReject(id) {
    document.getElementById('rejectSubId').value = id;
    new bootstrap.Modal(document.getElementById('rejectModal')).show();
}
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}å‘å¸ƒæ–°ä»»åŠ¡{% endblock %}

{% block head %}
<link href="https://cdn.bootcdn.net/ajax/libs/summernote/0.8.18/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/summernote/0.8.18/summernote-lite.min.js"></script>
<style>
    body { background-color: #f3f4f6; }
    .note-editor .note-toolbar { background: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold"><i class="fas fa-edit text-primary me-2"></i>å‘å¸ƒä»»åŠ¡ (V3 Enterprise)</h4>
                <a href="/admin/dashboard" class="btn btn-outline-secondary btn-sm">è¿”å›çœ‹æ¿</a>
            </div>
            
            <div class="card card-custom p-4 bg-white shadow-sm">
                <form action="/admin/task/new" method="post" enctype="multipart/form-data">
                    
                    <h6 class="fw-bold border-bottom pb-2 mb-3 text-muted">åŸºç¡€ä¿¡æ¯</h6>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">ä»»åŠ¡æ ‡é¢˜</label>
                            <input type="text" name="title" class="form-control" placeholder="ä¸€å¥è¯æè¿°ä»»åŠ¡æ ¸å¿ƒï¼Œå¦‚ï¼šæ³¨å†Œä¸‹è½½APPé€ç°é‡‘" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">ä»»åŠ¡åˆ†ç±»</label>
                            <select name="category" class="form-select">
                                {% for c in categories %}
                                <option value="{{ c.code }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="card bg-light border p-3 mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <label class="form-label fw-bold text-success">
                                    <i class="fas fa-money-bill-wave me-1"></i>ç»“ç®—æ¨¡å¼
                                </label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="price_mode" id="pm_fixed" value="fixed" checked onchange="toggleMode()">
                                        <label class="form-check-label" for="pm_fixed">å›ºå®šé‡‘é¢</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="price_mode" id="pm_dynamic" value="dynamic" onchange="toggleMode()">
                                        <label class="form-check-label" for="pm_dynamic">å®¡æ ¸æ—¶å®šä»·</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-8" id="fixedBox">
                                <label class="form-label fw-bold">å•ä»· (å…ƒ)</label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" step="0.01" name="price" id="inputPrice" class="form-control" placeholder="5.00">
                                </div>
                                <div class="form-text">ç”¨æˆ·å®Œæˆä¸€å•ï¼Œç›´æ¥å‘æ”¾æ­¤é‡‘é¢ã€‚</div>
                            </div>

                            <div class="col-md-8" id="dynamicBox" style="display:none;">
                                <div class="mb-2">
                                    <label class="form-label fw-bold">å±•ç¤ºä»·æ ¼æ–‡æ¡ˆ (ç”¨äºå¸å¼•çœ¼çƒ)</label>
                                    <input type="text" name="reward_desc_input" id="inputRewardDesc" class="form-control" placeholder="ä¾‹å¦‚ï¼š5-20å…ƒ / ä¸Šä¸å°é¡¶">
                                </div>
                                <div class="alert alert-warning py-1 px-2 small mb-0">
                                    <i class="fas fa-info-circle"></i> åŠ¨æ€æ¨¡å¼ä¸‹ï¼Œå…·ä½“é‡‘é¢ç”±ç®¡ç†å‘˜åœ¨å®¡æ ¸æ—¶æ‰‹åŠ¨è¾“å…¥ã€‚
                                </div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold border-bottom pb-2 mb-3 text-muted">èµ„æºä¸æŠ•æ”¾</h6>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold"><i class="fas fa-boxes me-1"></i>ç»‘å®šç´ æåº“</label>
                            <select name="material_cat_id" class="form-select border-warning">
                                <option value="0">ğŸš« ä¸ä½¿ç”¨ç´ æåº“ (ç”¨æˆ·è‡ªå¤‡å›¾)</option>
                                {% for mc in mat_categories %}
                                <option value="{{ mc.id }}">ğŸ“¦ {{ mc.name }} (å‰©ä½™: {{ mc.total_count - mc.used_count }})</option>
                                {% endfor %}
                            </select>
                            <div class="form-text small">ç»‘å®šåï¼Œç”¨æˆ·æ¥å•å°†è‡ªåŠ¨é¢†å–ä¸€å¥—â€œç‹¬å®¶â€å›¾æ–‡ã€‚</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-primary"><i class="fas fa-bullseye me-1"></i>å®šå‘æŠ•æ”¾ (ç”¨æˆ·åˆ†å±‚)</label>
                            <div class="card p-2 border-primary-subtle" style="min-height: 38px;">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="tags" value="newbie" id="tag_newbie">
                                    <label class="form-check-label" for="tag_newbie">ä»…é™æ–°æ‰‹</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="tags" value="vip" id="tag_vip">
                                    <label class="form-check-label fw-bold text-warning" for="tag_vip"><i class="fas fa-crown"></i> ä»…é™VIP</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" name="tags" value="high_credit" id="tag_credit">
                                    <label class="form-check-label" for="tag_credit">ä»…é«˜ä¿¡ç”¨åˆ†</label>
                                </div>
                            </div>
                            <div class="form-text small">ä¸å‹¾é€‰åˆ™é»˜è®¤å¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ã€‚</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">ä»»åŠ¡æ­¥éª¤è¯´æ˜</label>
                        <textarea name="description" id="summernote" required></textarea>
                    </div>

                    <div class="card bg-light p-3 mb-4">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small fw-bold">æ–‡å­—/é“¾æ¥éªŒè¯</label>
                                <select name="text_req" class="form-select form-select-sm">
                                    <option value="required">å¿…å¡« (éœ€è¦ç”¨æˆ·å¡«é“¾æ¥/è´¦å·)</option>
                                    <option value="none">æ— éœ€</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold">æˆªå›¾éªŒè¯</label>
                                <select name="image_req" class="form-select form-select-sm">
                                    <option value="required">å¿…å¡« (éœ€è¦ä¸Šä¼ æˆªå›¾)</option>
                                    <option value="none">æ— éœ€</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold fs-5 shadow-sm">
                        ğŸš€ ç¡®è®¤å‘å¸ƒä¸Šçº¿
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
    $(document).ready(function() {
        $('#summernote').summernote({
            placeholder: 'è¯·åœ¨æ­¤è¾“å…¥è¯¦ç»†çš„ä»»åŠ¡æ­¥éª¤ï¼Œæ”¯æŒä¸Šä¼ å›¾ç‰‡ã€è°ƒæ•´å­—ä½“é¢œè‰²...',
            tabsize: 2,
            height: 300,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear', 'color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['insert', ['link', 'picture', 'video']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            callbacks: {
                // å›¾ç‰‡ä¸Šä¼ å›è°ƒ (å¯é€‰ï¼šå¦‚æœéœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨è€Œé base64ï¼Œéœ€åœ¨æ­¤å®ç° AJAX)
                onImageUpload: function(files) {
                    // ç®€å•ç‰ˆç›´æ¥æ’ Base64ï¼Œå¦‚éœ€ä¼˜åŒ–å¯å¯¹æ¥åç«¯ /upload æ¥å£
                    $('#summernote').summernote('insertImage', URL.createObjectURL(files[0]));
                }
            }
        });
    });

    // 2. åˆ‡æ¢å®šä»·æ¨¡å¼
    function toggleMode() {
        var isDynamic = document.getElementById('pm_dynamic').checked;
        var fixedBox = document.getElementById('fixedBox');
        var dynamicBox = document.getElementById('dynamicBox');
        
        if (isDynamic) { 
            fixedBox.style.display = 'none';
            dynamicBox.style.display = 'block';
            document.getElementById('inputPrice').value = 0; // åŠ¨æ€æ¨¡å¼ä»·æ ¼ç½®0
        } else { 
            fixedBox.style.display = 'block';
            dynamicBox.style.display = 'none';
        }
    }
</script>
{% endblock %}
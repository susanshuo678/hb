{% extends "base.html" %}
{% block title %}ä¼šå‘˜ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold"><i class="fas fa-users text-primary me-2"></i>ä¼šå‘˜é£æ§ç®¡ç†</h4>
        <a href="/admin/dashboard" class="btn btn-outline-secondary">è¿”å›çœ‹æ¿</a>
    </div>

    <div class="card card-custom bg-white border-0 shadow-sm">
        <div class="card-body">
            <form class="row g-3 mb-4" method="get" action="/admin/users">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-search"></i></span>
                        <input type="text" name="keyword" class="form-control" placeholder="æœç´¢ç”¨æˆ·å / ID" value="{{ keyword }}">
                        <button type="submit" class="btn btn-primary px-4">æœç´¢</button>
                    </div>
                </div>
            </form>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·ä¿¡æ¯</th>
                            <th>è´¦å·çŠ¶æ€</th>
                            <th>å½“å‰ä½™é¢</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th class="text-end" style="min-width: 200px;">é£æ§æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in users %}
                        <tr class="{{ 'table-danger' if u.is_banned else '' }}">
                            <td><span class="text-muted">#{{ u.id }}</span></td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-2" style="width:36px; height:36px;">
                                        <i class="fas fa-user text-secondary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark">{{ u.username }}</div>
                                        {% if u.is_admin %}
                                        <span class="badge bg-dark" style="font-size: 0.7em;">ç®¡ç†å‘˜</span>
                                        {% endif %}
                                        {% if u.inviter_id %}
                                        <div class="text-muted small" style="font-size: 0.75rem;">ä¸Šçº§ID: {{ u.inviter_id }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if u.is_banned %}
                                <span class="badge bg-danger"><i class="fas fa-ban me-1"></i>å·²å°ç¦</span>
                                {% else %}
                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>æ­£å¸¸</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-bold text-danger fs-6">Â¥ {{ "%.2f"|format(u.balance) }}</span>
                            </td>
                            <td class="small text-muted">{{ u.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td class="text-end">
                                <form action="/admin/users/status" method="post" class="d-inline">
                                    <input type="hidden" name="user_id" value="{{ u.id }}">
                                    {% if u.is_banned %}
                                    <button name="action" value="unban" class="btn btn-sm btn-outline-success" onclick="return confirm('ç¡®å®šè¦è§£å°è¯¥ç”¨æˆ·å—ï¼Ÿ')">
                                        <i class="fas fa-unlock"></i> è§£å°
                                    </button>
                                    {% else %}
                                    <button name="action" value="ban" class="btn btn-sm btn-outline-danger" onclick="return confirm('âš ï¸ é«˜å±æ“ä½œï¼š\nç¡®å®šè¦å°ç¦è¯¥ç”¨æˆ·å—ï¼Ÿ\n\nå°ç¦åç”¨æˆ·å°†å¼ºåˆ¶ä¸‹çº¿ä¸”æ— æ³•ç™»å½•ã€‚')">
                                        <i class="fas fa-ban"></i> å°ç¦
                                    </button>
                                    {% endif %}
                                </form>

                                <button class="btn btn-sm btn-primary ms-1" onclick="openBalanceModal('{{ u.id }}', '{{ u.username }}', '{{ u.balance }}')">
                                    <i class="fas fa-coins"></i> è°ƒè´¦
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 opacity-25"></i>
                                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ä¼šå‘˜</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            {% if total_pages > 1 %}
            <nav class="mt-4 d-flex justify-content-center">
                <ul class="pagination">
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page-1 }}&keyword={{ keyword }}">
                            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                        </a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link text-dark fw-bold">ç¬¬ {{ page }} / {{ total_pages }} é¡µ</span>
                    </li>
                    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ page+1 }}&keyword={{ keyword }}">
                            ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade" id="balanceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="/admin/users/balance" method="post">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">ğŸ’° äººå·¥èµ„é‡‘è°ƒæ•´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="alert alert-primary d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            æ­£åœ¨æ“ä½œç”¨æˆ·ï¼š<strong id="modalUsername"></strong> (ID: <span id="modalUserIdDisplay"></span>)
                            <br>
                            å½“å‰ä½™é¢ï¼š<strong class="text-danger">Â¥ <span id="modalCurrentBalance"></span></strong>
                        </div>
                    </div>
                    
                    <input type="hidden" name="user_id" id="modalUserId">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">å˜åŠ¨é‡‘é¢ (æ”¯æŒè´Ÿæ•°)</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" step="0.01" name="amount" class="form-control form-control-lg" placeholder="è¾“å…¥é‡‘é¢" required>
                        </div>
                        <div class="form-text text-muted">
                            <span class="text-success"><i class="fas fa-plus-circle"></i> è¾“å…¥æ­£æ•° (å¦‚ 10) å¢åŠ ä½™é¢</span><br>
                            <span class="text-danger"><i class="fas fa-minus-circle"></i> è¾“å…¥è´Ÿæ•° (å¦‚ -10) æ‰£é™¤ä½™é¢</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">è°ƒæ•´åŸå›  (å¿…å¡«)</label>
                        <textarea name="reason" class="form-control" rows="2" placeholder="ä¾‹å¦‚ï¼šç³»ç»Ÿæ´»åŠ¨å¥–åŠ±è¡¥å‘ / è¿è§„æ‰£æ¬¾" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary px-4 fw-bold">ç¡®è®¤è°ƒæ•´</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openBalanceModal(uid, username, balance) {
        document.getElementById('modalUserId').value = uid;
        document.getElementById('modalUserIdDisplay').innerText = uid;
        document.getElementById('modalUsername').innerText = username;
        document.getElementById('modalCurrentBalance').innerText = parseFloat(balance).toFixed(2);
        
        var myModal = new bootstrap.Modal(document.getElementById('balanceModal'));
        myModal.show();
    }
</script>
{% endblock %}
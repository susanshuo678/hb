{% extends "base.html" %}
{% block title %}ç´ æåº“ç®¡ç†{% endblock %}

{% block head %}
<style>
    /* å°çº¢ä¹¦é£æ ¼å¼¹çª— */
    .xhs-modal .modal-dialog { max-width: 900px; width: 90%; }
    .xhs-modal .modal-content { border-radius: 16px; overflow: hidden; border: none; }
    .xhs-modal .modal-body { padding: 0; height: 70vh; display: flex; }
    .xhs-img-container { background-color: #000; display: flex; align-items: center; justify-content: center; height: 100%; overflow: hidden; position: relative; }
    .xhs-img-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .xhs-edit-container { padding: 24px; display: flex; flex-direction: column; height: 100%; overflow-y: auto; }
    
    /* è½®æ’­åˆ‡æ¢æŒ‰é’® */
    .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 50%; }
    .carousel-btn:hover { background: rgba(255,255,255,0.5); }
    .carousel-prev { left: 10px; } .carousel-next { right: 10px; }
    
    .material-card { cursor: pointer; transition: transform 0.2s; }
    .material-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">ğŸ’ ç´ æå¼¹è¯åº“ <span class="badge bg-primary fs-6 align-middle">V3.0 Pro</span></h4>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCatModal"><i class="fas fa-folder-plus"></i> æ–°å»ºåˆ†ç±»</button>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="list-group shadow-sm">
            {% for cat in categories %}
            <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="loadMaterials({{ cat.id }}, '{{ cat.name }}')">
                <span class="fw-bold">{{ cat.name }}</span>
                <span class="badge bg-secondary rounded-pill">{{ cat.total_count }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="col-md-9">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="m-0">ğŸ“‚ <span id="currentCatName" class="text-primary">è¯·é€‰æ‹©åˆ†ç±»</span></h5>
                <button class="btn btn-success btn-sm" onclick="$('#uploadArea').slideToggle()">
                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šä¼ ç´ æ
                </button>
            </div>
            <div class="card-body">
                <div id="uploadArea" style="display:none;" class="mb-4 p-3 bg-light rounded">
                    <form id="uploadForm">
                        <input type="hidden" name="cat_id" id="currentCatId">
                        <div class="mb-3">
                            <input type="file" name="files" class="form-control" multiple accept="image/*">
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="is_carousel" id="carouselSwitch">
                            <label class="form-check-label fw-bold" for="carouselSwitch">â­•ï¸ åˆå¹¶ä¸ºå¤šå›¾è½®æ’­è´´ (é€‰å¤šå¼ å›¾ç”Ÿæˆ1ä¸ªç´ æ)</label>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-12"><input type="text" name="title" class="form-control" placeholder="æ ‡é¢˜"></div>
                            <div class="col-12"><textarea name="content" class="form-control" rows="3" placeholder="æ–‡æ¡ˆå†…å®¹..."></textarea></div>
                        </div>
                        <button type="button" onclick="doUpload()" class="btn btn-primary w-100">ğŸš€ å¼€å§‹ä¸Šä¼ </button>
                    </form>
                </div>

                <div id="matList" class="row g-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade xhs-modal" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body row g-0">
                <div class="col-md-7 xhs-img-container">
                    <img id="modalImg" src="">
                    <button class="carousel-btn carousel-prev" onclick="prevImg()"><i class="fas fa-chevron-left"></i></button>
                    <button class="carousel-btn carousel-next" onclick="nextImg()"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="col-md-5 xhs-edit-container">
                    <h5 id="modalTitle" class="fw-bold mb-3"></h5>
                    <div id="modalContent" class="text-muted flex-grow-1" style="white-space: pre-wrap;"></div>
                    <div class="mt-3 d-flex justify-content-end border-top pt-3">
                         <button class="btn btn-outline-danger btn-sm" onclick="moveToRecycle()"><i class="fas fa-trash"></i> ç§»å…¥å›æ”¶ç«™</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentImages = [];
    let imgIndex = 0;
    let currentMatId = 0;

    function loadMaterials(catId, name) {
        $('#currentCatName').text(name);
        $('#currentCatId').val(catId);
        $('#matList').html('<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>');
        
        // ä½¿ç”¨ V3 è·¯ç”±
        $.get('/admin/materials/list/' + catId, function(res) {
            $('#matList').empty();
            if(res.length === 0) $('#matList').html('<p class="text-center text-muted col-12">æš‚æ— ç´ æ</p>');
            
            res.forEach(item => {
                // item.images åº”è¯¥æ˜¯ JSON å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼Œè¿™é‡Œåšå…¼å®¹å¤„ç†
                let imgs = (typeof item.images === 'string') ? JSON.parse(item.images) : item.images;
                let cover = imgs[0];
                let badge = imgs.length > 1 ? `<span class="position-absolute top-0 end-0 badge bg-dark m-2">1/${imgs.length}</span>` : '';
                
                let html = `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="card h-100 border-0 shadow-sm material-card" onclick='openModal(${JSON.stringify(item)})'>
                        <div class="position-relative">
                            <img src="${cover}" class="card-img-top" style="height:150px; object-fit:cover;">
                            ${badge}
                        </div>
                        <div class="card-body p-2">
                            <h6 class="text-truncate small mb-1 fw-bold">${item.title}</h6>
                        </div>
                    </div>
                </div>`;
                $('#matList').append(html);
            });
        });
    }

    function doUpload() {
        let formData = new FormData($('#uploadForm')[0]);
        // V3 ä¸Šä¼ æ¥å£
        $.ajax({
            url: '/admin/materials/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(res) {
                if(res.code === 200) {
                    Swal.fire('æˆåŠŸ', 'ä¸Šä¼ å®Œæˆ', 'success');
                    $('#uploadArea').slideUp();
                    $('#uploadForm')[0].reset();
                    loadMaterials($('#currentCatId').val(), $('#currentCatName').text());
                } else {
                    Swal.fire('å¤±è´¥', res.message, 'error');
                }
            }
        });
    }

    function openModal(item) {
        currentMatId = item.id;
        currentImages = (typeof item.images === 'string') ? JSON.parse(item.images) : item.images;
        imgIndex = 0;
        
        updateModalImg();
        $('#modalTitle').text(item.title);
        $('#modalContent').text(item.content);
        
        // æ§åˆ¶è½®æ’­æŒ‰é’®æ˜¾ç¤º
        $('.carousel-btn').toggle(currentImages.length > 1);
        
        new bootstrap.Modal('#detailModal').show();
    }

    function updateModalImg() {
        $('#modalImg').attr('src', currentImages[imgIndex]);
    }

    function nextImg() {
        imgIndex = (imgIndex + 1) % currentImages.length;
        updateModalImg();
    }
    
    function prevImg() {
        imgIndex = (imgIndex - 1 + currentImages.length) % currentImages.length;
        updateModalImg();
    }

    function moveToRecycle() {
        if(confirm('ç¡®å®šç§»å…¥å›æ”¶ç«™ï¼Ÿ')) {
            apiPost('/admin/materials/recycle', {mat_id: currentMatId}, function(){
                bootstrap.Modal.getInstance('#detailModal').hide();
                loadMaterials($('#currentCatId').val(), $('#currentCatName').text());
            });
        }
    }
</script>
{% endblock %}